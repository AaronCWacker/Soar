epmem --set learning on
epmem --set path epmem.sqlite3
epmem --set trigger none

sp {retrieve-first
   (state <s> ^superstate nil
             -^first
              ^epmem.command <c>)
-->
   (<c> ^retrieve 2)}

sp {propose*copy-first
   (state <s> ^superstate nil
             -^first
              ^epmem.result.retrieved <r>)
-->
   (<s> ^operator.name copy-first)}

sp {apply*copy-first
   (state <s> ^operator.name copy-first
              ^epmem.result.retrieved <r>)
-->
   (<s> ^first <r>)}

sp {detect-addition-intersect
   (state <s> ^first.atoms <a1>
              ^epmem.result.retrieved.atoms <a2>)
   (<a2> ^intersect <i2>)
   (<i2> ^a <a> ^b <b>)
 -{(<a1> ^intersect <i1>)
   (<i1> ^a <a> ^b <b>)}
-->
   (<s> ^addition t)}

sp {detect-removal-intersect
   (state <s> ^first.atoms <a1>
              ^epmem.result.retrieved.atoms <a2>)
   (<a1> ^intersect <i1>)
   (<i1> ^a <a> ^b <b>)
 -{(<a2> ^intersect <i2>)
   (<i2> ^a <a> ^b <b>)}
-->
   (<s> ^removal t)}

sp {retrieve-next
   (state <s> ^first <f>
             -^addition t
             -^removal t
              ^epmem.command <cmd>)
-->
   (<cmd> ^next <n>)}

sp {propose*get-next
   (state <s> ^first <f>
              ^epmem <epmem>
             -^addition t
             -^removal t)
   (<epmem> ^result.memory-id <mid>
            ^command.next <n>)
-->
   (<s> ^operator <o> +)
   (<o> ^name get-next
        ^remove <n>)}

sp {apply*wait-for-diff
   (state <s> ^operator <o>
              ^epmem.command <cmd>)
   (<o> ^name get-next
        ^remove <n>)
   (<cmd> ^next <n>)
-->
   (<cmd> ^next <n> - <n1>)}
